generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// SQLite doesn't support enums, using String with constraints instead

// Models
model Department {
  id        String   @id @default(cuid())
  name      String   @unique
  createdAt DateTime @default(now())
  
  profiles     Profile[]
  kpiTargets   KpiTarget[]
  ticketsSource Ticket[] @relation("TicketSource")
  ticketsTarget Ticket[] @relation("TicketTarget")
  
  @@map("departments")
}

model Profile {
  id         String    @id @default(cuid())
  email      String    @unique
  firstName  String
  lastName   String
  department String
  avatar     String?
  isActive   Boolean   @default(true)
  lastLogin  DateTime?
  createdAt  DateTime  @default(now())
  
  departmentRef Department @relation(fields: [department], references: [name])
  userRoles     UserRole[]
  kpiTargets    KpiTarget[]
  kpiAssignments KpiAssignment[]
  kpiProgress   KpiProgress[]
  kpiProgressRecorded KpiProgress[] @relation("KpiProgressRecorder")
  kpiComments   KpiComment[]
  ticketsCreated Ticket[] @relation("TicketCreated")
  ticketsAssigned Ticket[] @relation("TicketAssigned")
  ticketComments TicketComment[]
  calendarActivities CalendarActivity[]
  notifications Notification[]
  
  @@map("profiles")
}

model UserRole {
  id     String   @id @default(cuid())
  userId String
  role   String   // admin, department_manager, employee
  createdAt DateTime @default(now())
  
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([userId, role])
  @@map("user_roles")
}

model KpiTarget {
  id          String     @id @default(cuid())
  title       String
  description String?
  department  String
  targetValue Float
  currentValue Float     @default(0)
  unit        String
  startDate   String
  endDate     String
  period      String     // monthly, quarterly, yearly
  priority    String     // low, medium, high, critical
  status      String     @default("active") // active, completed, paused, cancelled
  createdBy   String
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @default(now())
  
  departmentRef Department @relation(fields: [department], references: [name])
  creator       Profile    @relation(fields: [createdBy], references: [id])
  assignments   KpiAssignment[]
  progress      KpiProgress[]
  comments      KpiComment[]
  
  @@map("kpi_targets")
}

model KpiAssignment {
  id       String   @id @default(cuid())
  kpiId    String
  userId   String
  assignedAt DateTime @default(now())
  
  kpi  KpiTarget @relation(fields: [kpiId], references: [id], onDelete: Cascade)
  user Profile  @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@unique([kpiId, userId])
  @@map("kpi_assignments")
}

model KpiProgress {
  id         String   @id @default(cuid())
  kpiId      String
  userId     String
  value      Float
  note       String?
  recordedAt DateTime @default(now())
  recordedBy String
  
  kpi         KpiTarget @relation(fields: [kpiId], references: [id], onDelete: Cascade)
  user        Profile   @relation(fields: [userId], references: [id])
  recorder    Profile   @relation("KpiProgressRecorder", fields: [recordedBy], references: [id])
  
  @@map("kpi_progress")
}

model KpiComment {
  id       String   @id @default(cuid())
  kpiId    String
  userId   String
  userName String
  content  String
  createdAt DateTime @default(now())
  
  kpi  KpiTarget @relation(fields: [kpiId], references: [id], onDelete: Cascade)
  user Profile  @relation(fields: [userId], references: [id])
  
  @@map("kpi_comments")
}

model Ticket {
  id              String        @id @default(cuid())
  title           String
  description     String
  priority        String        // low, medium, high, urgent
  status          String        @default("open") // open, in_progress, resolved, closed
  sourceDepartment String
  targetDepartment String
  createdBy       String
  creatorName     String?
  creatorEmail    String?
  assignedTo      String?
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @default(now())
  resolvedAt      DateTime?
  closedAt        DateTime?
  
  sourceDepartmentRef Department @relation("TicketSource", fields: [sourceDepartment], references: [name])
  targetDepartmentRef Department @relation("TicketTarget", fields: [targetDepartment], references: [name])
  creator              Profile   @relation("TicketCreated", fields: [createdBy], references: [id])
  assignee             Profile?  @relation("TicketAssigned", fields: [assignedTo], references: [id])
  comments             TicketComment[]
  
  @@map("tickets")
}

model TicketComment {
  id        String   @id @default(cuid())
  ticketId  String
  authorId  String
  authorName String
  content   String
  isInternal Boolean @default(false)
  createdAt DateTime @default(now())
  
  ticket Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)
  author Profile @relation(fields: [authorId], references: [id])
  
  @@map("ticket_comments")
}

model CalendarCategory {
  id        String   @id @default(cuid())
  name      String   @unique
  color     String
  createdAt DateTime @default(now())
  
  activities CalendarActivity[]
  
  @@map("calendar_categories")
}

model CalendarActivity {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String?
  date        String
  startTime   String?
  endTime     String?
  duration    Int
  categoryId  String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @default(now())
  
  user     Profile           @relation(fields: [userId], references: [id], onDelete: Cascade)
  category CalendarCategory? @relation(fields: [categoryId], references: [id])
  
  @@map("calendar_activities")
}

model Notification {
  id       String               @id @default(cuid())
  userId   String
  category String               // kpi, ticket, calendar, system, user
  priority String               // low, medium, high, critical
  title    String
  message  String
  isRead   Boolean              @default(false)
  link     String?
  metadata String? // JSON string
  createdAt DateTime            @default(now())
  
  user Profile @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@map("notifications")
}
